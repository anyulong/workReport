define("bui/navlist",['bui/common','bui/overlay','bui/mainlayout'],function(require){var BUI=require('bui/common'),UIMessage=require('bui/overlay/message');var DEFAULT_CLASS="dropdown";var UL_CLASS="dropdown-menu";var SUBMENU_CLASS="dropdown-submenu";var navlist=BUI.Component.Controller.extend([],{renderUI:function(){var _self=this;var url=_self.get("url");var root=_self.get("root");if(!url){var records=_self._formatData(_self.get("data"));_self.set("data",records);_self._createDom();}else{$.ajax({url:_self.get("url"),data:_self.get("params"),dataType:_self.get("dataType"),success:function(result){if(BUI.isArray(result[root])){var records=_self._formatData(result[root]);_self.set("data",records);_self._createDom();}},error:function(errMsg){UIMessage.Alert(errMsg,"error");}});}},_createDom:function(){var _self=this;var items=_self.get("data");var contentId=_self.get("srcNode");$(contentId).append(_self.get("tpl"));var srcNode=_self.get("srcNode");$(srcNode).addClass("nav-hide");BUI.each(items,function(element,index){if(!_self._hasChildren(element)){var tpl=BUI.substitute(_self.get("litpl"),element);if(_self._getParentNode(element['pid']).find("ul").length){$(tpl).appendTo(_self._getParentNode(element['pid']).find("ul:first"));}else{$("ul.bui-nav-list",contentId).append(tpl);}}else if(_self._hasChildren(element)){var tpl=BUI.substitute(_self.get("sublitpl"),element);if(_self._getParentNode(element['pid']).find("ul").length){$(tpl).appendTo(_self._getParentNode(element['pid']).find("ul:first"));}else{$("ul.bui-nav-list",contentId).append(tpl);}_self._addChildNode(element);}});$(srcNode).removeClass("nav-hide");_self._bindTriggerEvent();_self._bindNodeEvent();_self._setMainIcons();_self.fire("afterRenderUI");},_addChildNode:function(node){var _self=this;var childrenNodes=_self._getChildrenNodes(node);BUI.each(childrenNodes,function(element,index){if(_self._getParentNode(element['pid']).find("ul").length){return true;}else{_self._getParentNode(element['pid']).append(_self.get("ultpl"));}});},_hasChildren:function(node){var _self=this,haschild=false;var items=_self.get('data');BUI.each(items,function(element,index){if(element['pid']==node['id']){haschild=true;return false;}});return haschild;},_getChildrenNodes:function(node){var _self=this,childrenNodes=[];var items=_self.get('data');BUI.each(items,function(element,index){if(element['pid']==node['id']){childrenNodes.push(element);}});return childrenNodes;},_getParentNode:function(nodeId){var _self=this;var contentId=_self.get("srcNode");var parentNode=contentId.find("li[data-index='"+nodeId+"']");return parentNode;},_bindNodeEvent:function(){var _self=this;var el=_self.get("el");var items=_self.get("data");el.on('click',function(ev){var item=ev.target;if(item.tagName==="A"){var nodeIndex=$(item).parents("li:first").data("index");var node={};BUI.each(items,function(element,index){if(element['id']==nodeIndex){node=element;return false;}});_self.fire('itemclick',{item:node});if(!_self.get("isAbsolute"))el.find(".dropdown:first").hide();}});},_formatData:function(items){var _self=this;var map=_self.get("map");var rst=new Array();if(map){BUI.each(items,function(v,k){for(var o in map){rst[k]=v;rst[k][map[o]]=v[o];delete rst[k][o];}});rst.record=items;}else{rst=items;}return rst;},_bindTriggerEvent:function(){var _self=this;var el=_self.get("el");var triggerEvent=_self.get("triggerEvent");var domTarget=el.attr("data-toggle");if(domTarget){$("#"+domTarget).on(triggerEvent,function(ev){el.find(".dropdown:first").show();});el.on("mouseleave",function(ev){if(!_self.get("isAbsolute"))el.find(".dropdown:first").hide();});}},_setMainIcons:function(){var _self=this,el=_self.get("el"),iconsList=_self.get("icons");$(".dropdown>ul.bui-nav-list>li",el).each(function(index,dom){var $node=$(">a:first",$(dom)),iconHtml='<span class="icon icon-';iconHtml+=iconsList[index]+'"></span>';contentHtml=$node.html();contentHtml=iconHtml+contentHtml;$node.html(contentHtml);});},selectedItem:function(nodeId){var _self=this;var contentId=_self.get("srcNode");var node=contentId.find("li[data-index='"+nodeId+"'] >a");_self._clearSelected();node.addClass("active").parents("li").find("a:first").addClass("active");},getParentItems:function(node){var _self=this,parentItems=new Array(),items=_self.get("data");parentItems.push(node);for(var i=0;i<items.length;i++){if(items[i]['id']==node['pid']){parentItems.push(items[i]);parentNode(items[i]);}};function parentNode(item){if(item['pid']||item['pid']!=""){for(var i=0;i<items.length;i++){if(items[i]['id']==item['pid'])parentItems.push(items[i]);};}}return parentItems;},_clearSelected:function(){var _self=this;var contentId=_self.get("srcNode");var nodes=contentId.find("li>a");nodes.removeClass("actiove");}},{ATTRS:{tpl:{value:'<div class="'+DEFAULT_CLASS+' clearfix"><ul class="bui-nav-list '+UL_CLASS+'"></ul></div>'},ultpl:{value:'<ul class="'+UL_CLASS+'"></ul>'},litpl:{value:'<li data-index="{id}"><a href="javascript:void(0);" class="{activeCls}">{text}</a></li>'},sublitpl:{value:'<li  data-index="{id}" class="'+SUBMENU_CLASS+'"><a href="javascript:void(0);" class="{activeCls}">{text}<span class="icon-arrow-right"></span></a></li>'},icons:{value:["policy","mana","claim","print","charge","final","receipt","table","person","feed","money","storage","security","setting"]},url:{value:""},params:{value:{}},data:{value:[]},dataType:{value:"json"},isAbsolute:{value:true},root:{value:"results"},map:{},triggerEvent:{value:"mouseenter"},events:{value:{'click':true,'afterRenderUI':true}}}});return navlist;});